app-id: chat.delta.desktop
branch: stable
tags:
  - delta.chat
  - email
  - chat
  - messenger
  - crypto
base: io.atom.electron.BaseApp
base-version: '18.08'
runtime: org.freedesktop.Platform
runtime-version: '18.08'
sdk: org.freedesktop.Sdk
command: /app/bin/run.sh
#rename-icon: deltachat-desktop
#rename-desktop-file: deltachat-desktop.desktop
finish-args:
  - --socket=x11
  - --share=ipc
  # We can record and play voice messages
  - --socket=pulseaudio
  # Without DRI the app doesn't come up :-/
  - --device=dri
  # It connects to the network to send and receive messages
  - --share=network
  # I guess it wants to show notification.
  - --talk-name=org.freedesktop.Notifications

build-options:
    env:
        NPM_CONFIG_LOGLEVEL: info


environment:
    # The app loads dynamic modules at runtime. And we potentially install libaries ourselves
    LD_LIBRARY_PATH: /app/lib/

modules:
  # Running the app requires libsasl2 :(
  # 2.1.26 doesn't compile due with the SDK's openssl, because it is too new.
  # 2.1.27 bumps the soname (? in a minor release? ...) which cannot be used by deltachat
  - name: cyrus-sasl2
    disabled: true
    config-opts:
        # It fails to build with DES
        - --without-des
    sources:
        - type: archive
          url: https://www.cyrusimap.org/releases/cyrus-sasl-2.1.26.tar.gz
          sha256: 8fbc5136512b59bb793657f36fadda6359cae3b08f01fd16b3d406f1345b7bc3

    modules:
        - name: openssl
          sources:
            - type: script
              dest-filename: configure
              commands:
                - ./config $@              
            
            - type: archive
              url: https://www.openssl.org/source/openssl-1.0.2p.tar.gz
              sha256: 50a98e07b1a89eb8f6a99477f262df71c6fa7bef77df4dc83025a2845c827d00

  - name: cyrus-sasl2
    disabled: false
    sources:
        - type: archive
          url: https://www.cyrusimap.org/releases/cyrus-sasl-2.1.27.tar.gz
          sha256: 26866b1549b00ffd020f188a43c258017fa1c382b3ddadd8201536f72efb05d5


  - name: nodejs
    cleanup:
        - "/include"
        - "/share"
        - "/app/lib/node_modules/npm/changelogs"
        - "/app/lib/node_modules/npm/doc"
        - "/app/lib/node_modules/npm/html"
        - "/app/lib/node_modules/npm/man"
        - "/app/lib/node_modules/npm/scripts"       
    sources:
        - type: archive
          url: https://nodejs.org/dist/v8.13.0/node-v8.13.0.tar.xz
          sha256: 2aa99474a336c6339d14f08cc27d387c5168e6fb6cbcaaea1d5ff7aa89642de2
  
  - name: deltachat-core
    buildsystem: meson
    sources:
        - type: archive
          url: https://github.com/deltachat/deltachat-core/archive/v0.26.0.tar.gz
          sha256: 156fe4959198caf3516b9df46e51de4b5152e744dbbd7f362d92f8a94c07a471

  - name: deltachat-node
    disabled: true
    buildsystem: meson
    sources:
        - type: archive
          url: https://github.com/deltachat/deltachat-node/archive/v0.24.0.tar.gz
          sha256: 7f7db012408079486f1c3e623758b41716b98773a7ddeb5695511451539ed720

  - name: delta
    buildsystem: simple
    build-options:
        env:
            electron_config_cache: /run/build/delta/npm-cache
            npm_config_nodedir: /app/
            #npm_config_devdir: /run/build/delta/npm-dev
            npm_config_devdir: /app
            ELECTRON_CACHE: /run/build/delta/npm-cache
    build-commands:
        - npm install  --offline --cache=/run/build/delta/npm-cache/  --verbose
        - npm run build  --offline --cache=/run/build/delta/npm-cache/  --verbose
        # This seems to be the appropriate command equivalent to a "make install". Unfortunately, it doesn't work :(
        # - ./node_modules/.bin/electron-builder build --linux dir
        - mkdir -p /app/delta /app/bin
        # Not knowing how else to install the app into a certain prefix, we copy everything :(
        - cp -ra * /app/
        - install run.sh /app/bin/
        - install -Dm 0644 chat.delta.desktop  /app/share/applications/chat.delta.desktop.desktop
        - install -Dm 0644 static/chat.delta.desktop.appdata.xml  /app/share/appinfo/chat.delta.desktop.aappdata.xml
        # FIXME: Where do we find the icon?!
        #- install -Dm 0644 /app/share/icons/HighContrast/scalable/apps/accessories-calculator.svg /app/share/icons/hicolor/scalable/apps/chat.delta.desktop.svg
        - install -Dm 0644 chat.delta.desktop.png /app/share/icons/hicolor/256x256/apps/chat.delta.desktop.png
        - install -Dm 0644 chat.delta.desktop.png /app/share/icons/hicolor/128x128/apps/chat.delta.desktop.png
        - install -Dm 0644 chat.delta.desktop.png /app/share/icons/hicolor/64x64/apps/chat.delta.desktop.png
        - install -Dm 0644 chat.delta.desktop.png /app/share/icons/hicolor/32x32/apps/chat.delta.desktop.png
        - install -Dm 0644 chat.delta.desktop.png /app/share/icons/hicolor/16x16/apps/chat.delta.desktop.png
        - find . -name '*.tar.xz'
        #- npm ls
        

    sources:
        - generated-sources.json
        # Of course, not all electron packages are equal *sigh*
        # This one downloads files at installation time.
        # Taken from https://github.com/electron/chromedriver/issues/28#issuecomment-427839364
        - type: file
          url: https://github.com/electron/electron/releases/download/v3.0.0/chromedriver-v3.0.0-linux-x64.zip
          sha256: 31c59d42d80001721dbdbf2f2c8b3b527bdb8df38c766b020329cb46cf1d3bb4
          dest: npm-cache

        - type: file
          url: https://github.com/electron/electron/releases/download/v3.0.0/SHASUMS256.txt
          sha256: 6560dd88350be568ff29cdb1cdb05e68304268b821b1d5040f9a5fde901ef670
          dest-filename: SHASUMS256.txt-3.0.0
          dest: npm-cache

        - type: archive
          url: https://github.com/deltachat/deltachat-desktop/archive/v0.90.1.tar.gz
          sha256: 9d3b75fd49143d31eececd63da0a0f62fdb89140042e57b5b299c71cf5cedea8

        - type: file
          path: package-lock.json
          dest-filename: package-lock.json

        - type: file # This is generated somehow by that electron builder, but I can't find it.
          path: chat.delta.desktop

        - type: file # This is generated somehow by that electron builder, but I can't find it.
          path: chat.delta.desktop.256.png
          dest-filename: chat.delta.desktop.png

        - type: script # This starts the debug mode. Is there a way to launch the app normally?
          dest-filename: run.sh
          commands:
            - npm start --prefix=/app/
          

  - name: delta-binary
    disabled: true
    buildsystem: simple
    build-commands:
        - ar x deltachat-desktop_0.90.*_amd64.deb
        - tar xvf data.tar.xz
        - cp -ar usr/share/ /app/
        - cp -ar opt /app/
        - ls -la /app/share/applications/
        # Yeah, /opt/ is hardcoded in that .desktop file
        - sed -i s,/opt/DeltaChat/deltachat-desktop,/app/opt/DeltaChat/deltachat-desktop,  /app/share/applications/deltachat-desktop.desktop
        - cp -ar /app/lib/libsasl2*  /app/opt/DeltaChat
        
    sources:
      - type: file
        path: chat.delta.desktop.appdata.xml

      - type: file
        url: https://github.com/deltachat/deltachat-desktop/releases/download/v0.90.1/deltachat-desktop_0.90.1_amd64.deb
        sha256: 735d33d00ec79f768f7224b14153bf526e3738ffefeb7249315b6f4e19dbb81c
