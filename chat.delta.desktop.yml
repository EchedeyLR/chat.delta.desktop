app-id: chat.delta.desktop
base: io.atom.electron.BaseApp
base-version: '18.08'
runtime: org.freedesktop.Platform
runtime-version: '18.08'
sdk: org.freedesktop.Sdk
command: /app/bin/run.sh
finish-args:
  - --socket=x11
  - --share=ipc
  - --device=dri         # Without DRI the app doesn't come up :-/
  - --socket=pulseaudio  # Record and play voice messages
  - --filesystem=home
  - --share=network
  - --talk-name=org.freedesktop.Notifications

build-options:
    env:
        NPM_CONFIG_LOGLEVEL: info

modules:

  # Build node.js.  We need to dynamically link to OpenSSL and libz
  # because our deltachat-node extension module also uses these
  # libraries and we need to use the same objects for each symbol.
  # For deltachat-core-rust this is no longer true, but it's still
  # better to re-use these libraries from the Platform SDK rather than
  # increase the download size of this application.
  - name: nodejs
    buildsystem: autotools
    config-opts:
      - --shared-openssl
      - --shared-zlib
    cleanup:
      - /include
      - /share
      - /app/lib/node_modules/npm/changelogs
      - /app/lib/node_modules/npm/doc
      - /app/lib/node_modules/npm/html
      - /app/lib/node_modules/npm/man
      - /app/lib/node_modules/npm/scripts
    sources:
      - type: archive
        url: https://nodejs.org/dist/v10.15.3/node-v10.15.3.tar.gz
        sha256: db460a63d057ac015b75bb6a879fcbe2fefaaf22afa4b6f6445b9db61ce2270d

  
  # libsasl is not in the org.freedekstop.Platform runtime but needed
  # by deltachat-core.
  - name: cyrus-sasl2
    disabled: true
    buildsystem: autotools
    config-opts:
      # Disable a number of obsolete things, enable some required so
      # we get build-failures if they are not present.
      - --enable-shared
      - --disable-cmulocal
      - --disable-sample
      - --disable-obsolete_cram_attr
      - --disable-obsolete_digest_attr
      - --disable-alwaystrue
      - --enable-checkapop
      - --enable-cram
      - --enable-digest
      - --enable-scram
      - --enable-plain
      - --enable-anon
      - --enable-login
    cleanup:
      - /include
      - /share
    sources:
      - type: archive
        url: https://ftp.osuosl.org/pub/blfs/conglomeration/cyrus-sasl/cyrus-sasl-2.1.27.tar.gz
        sha256: 26866b1549b00ffd020f188a43c258017fa1c382b3ddadd8201536f72efb05d5

  - name: deltachat-core-rust
    buildsystem: simple
    build-options:
      env:
        CARGO_HOME: /run/build/deltachat-core-rust/cargo
      append-path: /app/lib/sdk/rust-nightly/bin
      #build-args:
      #  - --share=network
    cleanup:
        - /include
    build-commands:
      - type -a rustc
      - type -a cargo
      - rustc --version
      - rustc -vV
      - cargo -Z unstable-options build -p deltachat_ffi --release --out-dir /app/lib/ --verbose
      - install -D -m a+r deltachat-ffi/deltachat.h  /app/include/deltachat/deltachat.h
      - install -D -m a+r deltachat.pc  /app/lib/pkgconfig/deltachat.pc
      - find /app -name '*delta*.so'
      - pkg-config --libs deltachat
    modules:
      - name: rust-nightly-2019-06-16
        cleanup:
          # We don't need rust in the final application, only build-time
          - /lib/sdk/rust-nightly
        buildsystem: simple
        build-commands:
          - ./install.sh --prefix=/app/lib/sdk/rust-nightly --disable-ldconfig --verbose
        sources:
          - type: archive
            only-arches: ["x86_64"]
            url: https://static.rust-lang.org/dist/2019-06-16/rust-nightly-x86_64-unknown-linux-gnu.tar.gz
            sha256: 2b871b763f2d89835e9a29f76160e82ad754038e5519ee208c8c2ab01b1152a0
    sources:
      - type: archive
        url: https://github.com/deltachat/deltachat-core-rust/archive/1.0.0-beta.1.tar.gz
        sha256: 0dedd2c94a0bc60d6e485dc9d6fbe3f0777cc51401176f34171908601e375671
      - generated-sources-rust.json


  - name: delta
    buildsystem: simple
    build-options:
      env:
        # Tell electron where we pre-downloaded things.
        electron_config_cache: /run/build/delta/npm-cache

        # Point node-gyp to our node.js installation so that it won't
        # try to download the headers and source.
        npm_config_nodedir: /app/
        npm_config_devdir: /app

        # Tell the chromedriver npm package where we pre-downloaded things.
        ELECTRON_CACHE: /run/build/delta/npm-cache
    build-commands:
      # Ugly hack for remark-contributors.  This is an npm dependency
      # which uses github rather than a published package.  The
      # generated-sources-npm.json tries to fix this by re-writing the
      # URL to be local, but it does not handle this for the
      # dependency of remark-git-contributors on remark-contributors.
      # However since we already pull in remark-contributors we can
      # just delete that dependency.  flatpak-npm-generator.py should
      # be fixed really.
      # - sed -i '/remark-contributors.*github:hughsk\/remark-contributors/s/\(github:hughsk\/remark-contributors#\)/git+file:\/home\/flub\/delta\/chat.delta.desktop\/.flatpak-builder\/build\/delta\/flatpak-node\/git-packages\/remark-contributors-/' package-lock.json

      # Install the deltachat-desktop npm package
      - npm install --offline --cache=/run/build/delta/npm-cache/ --verbose --dc-system-lib=true
      - npm run pack --offline --cache=/run/build/delta/npm-cache/ --verbose
      - mkdir -p /app/delta
      - cp -ar dist/linux-unpacked/* /app/delta/

      # Install the required static files
      - install run.sh /app/bin/run.sh
      - install -Dm 0644 chat.delta.desktop.desktop  /app/share/applications/chat.delta.desktop.desktop
      - install -Dm 0644 static/chat.delta.desktop.appdata.xml  /app/share/metainfo/chat.delta.desktop.appdata.xml
      - install -Dm 0644 delta-v7-pathed.svg /app/share/icons/hicolor/scalable/apps/chat.delta.desktop.svg
    sources:
      # The chromedriver package tries to download a bunch of files
      # outside of the normal npm dependencies.  Pre-download them and
      # use ELECTRON_CACHE to point to them.
      # Taken from https://github.com/electron/chromedriver/issues/28#issuecomment-42783936
      - type: file
        only-arches: ["x86_64"]
        url: https://github.com/electron/electron/releases/download/v3.0.0/chromedriver-v3.0.0-linux-x64.zip
        sha256: 31c59d42d80001721dbdbf2f2c8b3b527bdb8df38c766b020329cb46cf1d3bb4
        dest: npm-cache
      - type: file
        url: https://github.com/electron/electron/releases/download/v3.0.0/SHASUMS256.txt
        sha256: 6560dd88350be568ff29cdb1cdb05e68304268b821b1d5040f9a5fde901ef670
        dest-filename: SHASUMS256.txt-3.0.0
        dest: npm-cache

      - type: archive
        url: https://github.com/deltachat/deltachat-desktop/archive/v0.201.0.tar.gz
        sha256: e9e7f899d9336c3924a947de7cfd2718d8e7154246f866d2d5e71c0f0a203de7

      - type: file
        url: https://raw.githubusercontent.com/deltachat/interface/970c5df39866695b5e8ebdd73caa68cbb6de5242/icons/delta-v7-pathed.svg
        sha256: 1787a9dfdd80301ae5dbe48105bd58215c6552bd8ecfa4efd15fe6d31ba31274
        dest-filename: delta-v7-pathed.svg

      - type: file
        path: chat.delta.desktop.desktop

      - type: file
        path: chat.delta.desktop.256.png
        dest-filename: chat.delta.desktop.png

      - type: script
        dest-filename: run.sh
        commands:
          - /app/delta/deltachat-desktop

      # All the generated npm downloads, see README.md how to create
      # this file.  This needs to go to the bottom so that the
      # commands in that file can see package.json and friends.
      - generated-sources-npm.json
